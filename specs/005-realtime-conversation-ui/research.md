# Research: Realtime Conversation UI

**Feature**: 005-realtime-conversation-ui
**Date**: 2025-12-31

## ç ”ç©¶æ‘˜è¦

æœ¬ç ”ç©¶æ¢è¨å¦‚ä½•åœ¨ç¾æœ‰ FastRTC èªéŸ³åŠ©ç†ä¸­æ•´åˆå³æ™‚å°è©±é¡¯ç¤ºåŠŸèƒ½ï¼Œä¸»è¦èšç„¦æ–¼ Gradio Blocks UI è‡ªå®šç¾©å’Œ AdditionalOutputs æ©Ÿåˆ¶ã€‚

---

## Research 1: FastRTC AdditionalOutputs æ©Ÿåˆ¶

### å•é¡Œ

å¦‚ä½•åœ¨ WebRTC éŸ³è¨Šä¸²æµéç¨‹ä¸­åŒæ­¥æ›´æ–°å…¶ä»– Gradio å…ƒä»¶ï¼ˆå¦‚æ–‡å­—é¡¯ç¤ºå€ï¼‰ï¼Ÿ

### æ±ºå®š

ä½¿ç”¨ FastRTC çš„ `AdditionalOutputs` é¡åˆ¥ï¼Œåœ¨ handler å‡½å¼ä¸­ yield é¡å¤–è³‡æ–™ã€‚

### ç†ç”±

1. FastRTC å®˜æ–¹æ–‡ä»¶æ˜ç¢ºæ”¯æ´æ­¤æ¨¡å¼
2. ä¸éœ€è¦é¡å¤–çš„ WebSocket æˆ–è¼ªè©¢æ©Ÿåˆ¶
3. èˆ‡ç¾æœ‰ `ReplyOnPause` handler ç„¡ç¸«æ•´åˆ

### æ›¿ä»£æ–¹æ¡ˆ

| æ–¹æ¡ˆ | å„ªé» | ç¼ºé» | çµè«– |
|------|------|------|------|
| WebSocket ç¨ç«‹é€šé“ | å®Œå…¨è§£è€¦ | è¤‡é›œåº¦é«˜ã€éœ€é¡å¤–ç¶­è­· | âŒ ä¸æ¡ç”¨ |
| è¼ªè©¢ API | ç°¡å–® | å»¶é²é«˜ã€è³‡æºæµªè²» | âŒ ä¸æ¡ç”¨ |
| **AdditionalOutputs** | åŸç”Ÿæ”¯æ´ã€ä½å»¶é² | éœ€ä¿®æ”¹ handler | âœ… æ¡ç”¨ |

### å¯¦ä½œç¯„ä¾‹

```python
from fastrtc import AdditionalOutputs

def process_audio(audio):
    # ... è™•ç†éŸ³è¨Š ...
    user_text = stt.transcribe(audio)
    response = llm.chat(user_text)

    # ç™¼é€é¡å¤–è¼¸å‡ºï¼ˆå°è©±è¨˜éŒ„ï¼‰
    yield AdditionalOutputs(conversation_history, current_status)

    # ç¹¼çºŒ yield éŸ³è¨Š
    for chunk in tts.stream(response):
        yield chunk
```

---

## Research 2: Gradio Blocks è‡ªå®šç¾© UI

### å•é¡Œ

å¦‚ä½•æ›¿æ› FastRTC Stream é è¨­ UI ç‚ºè‡ªå®šç¾©çš„ Gradio Blocksï¼Ÿ

### æ±ºå®š

ä½¿ç”¨ `stream.ui = custom_blocks` è¨­å®šè‡ªå®šç¾© UIã€‚

### ç†ç”±

1. FastRTC Stream æä¾› `ui` å±¬æ€§çš„ setter
2. å¯å®Œå…¨æ§åˆ¶ UI ä½ˆå±€å’Œå…ƒä»¶
3. ä¿æŒ WebRTC é€£ç·šé‚è¼¯ä¸è®Š

### UI ä½ˆå±€è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI èªéŸ³åŠ©ç†                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç‹€æ…‹: [å¾…å‘½ | è†è½ä¸­ | è™•ç†ä¸­ | å›æ‡‰ä¸­]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  ğŸ‘¤ ä½¿ç”¨è€…: ä»Šå¤©å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ                            â”‚â”‚
â”‚  â”‚  ğŸ¤– åŠ©ç†: å°åŒ—ä»Šå¤©æ™´å¤©ï¼Œæ°£æº« 25 åº¦...                     â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  ğŸ‘¤ ä½¿ç”¨è€…: ç¾é‡‘åŒ¯ç‡å¤šå°‘ï¼Ÿ                                â”‚â”‚
â”‚  â”‚  ğŸ¤– åŠ©ç†: ç›®å‰ç¾é‡‘å…Œå°å¹£åŒ¯ç‡æ˜¯...                         â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ¤ WebRTC éŸ³è¨Šå…ƒä»¶]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµå…ƒä»¶

| å…ƒä»¶ | Gradio é¡å‹ | ç”¨é€” |
|------|-------------|------|
| ç‹€æ…‹æŒ‡ç¤º | `gr.Textbox` | é¡¯ç¤ºç•¶å‰ç‹€æ…‹ |
| å°è©±è¨˜éŒ„ | `gr.Chatbot` | é¡¯ç¤ºå°è©±æ­·å² |
| éŸ³è¨Šè¼¸å…¥ | `WebRTC` | èªéŸ³ä¸²æµ |

---

## Research 3: Gradio Chatbot å…ƒä»¶

### å•é¡Œ

ä½¿ç”¨ä½•ç¨® Gradio å…ƒä»¶æœ€é©åˆé¡¯ç¤ºå°è©±è¨˜éŒ„ï¼Ÿ

### æ±ºå®š

ä½¿ç”¨ `gr.Chatbot` å…ƒä»¶ï¼Œå®ƒåŸç”Ÿæ”¯æ´å°è©±æ ¼å¼é¡¯ç¤ºã€‚

### ç†ç”±

1. å…§å»ºä½¿ç”¨è€…/åŠ©ç†è¨Šæ¯å€åˆ†
2. è‡ªå‹•è™•ç†æ²å‹•å’Œæ¨£å¼
3. æ”¯æ´ Markdown æ ¼å¼åŒ–

### æ ¼å¼

```python
# Chatbot æ¥å—çš„æ ¼å¼
messages = [
    {"role": "user", "content": "ä»Šå¤©å°åŒ—å¤©æ°£å¦‚ä½•ï¼Ÿ"},
    {"role": "assistant", "content": "å°åŒ—ä»Šå¤©æ™´å¤©ï¼Œæ°£æº« 25 åº¦..."},
]
```

---

## Research 4: ç‹€æ…‹é¡¯ç¤ºè¨­è¨ˆ

### å•é¡Œ

å¦‚ä½•å³æ™‚é¡¯ç¤ºç³»çµ±ç‹€æ…‹ï¼ˆé–’ç½®/è†è½/è™•ç†/å›æ‡‰ï¼‰ï¼Ÿ

### æ±ºå®š

ä½¿ç”¨ `gr.Textbox` é…åˆæ¨£å¼è®ŠåŒ–é¡¯ç¤ºç‹€æ…‹ã€‚

### ç‹€æ…‹å°æ‡‰

| VoiceState | é¡¯ç¤ºæ–‡å­— | å»ºè­°æ¨£å¼ |
|------------|----------|----------|
| IDLE | ğŸŸ¢ å¾…å‘½ | ç¶ è‰² |
| LISTENING | ğŸ¤ è†è½ä¸­... | è—è‰² |
| PROCESSING | â³ è™•ç†ä¸­... | é»ƒè‰² |
| SPEAKING | ğŸ”Š å›æ‡‰ä¸­... | ç´«è‰² |
| INTERRUPTED | â¸ï¸ å·²ä¸­æ–· | ç°è‰² |

---

## Research 5: ç¾æœ‰ç¨‹å¼ç¢¼æ•´åˆé»

### åˆ†æçµæœ

| æª”æ¡ˆ | ç¾æœ‰ç‹€æ…‹ | éœ€è¦ä¿®æ”¹ |
|------|----------|----------|
| `pipeline.py` | å·²è¿½è¹¤ `last_user_text`, `last_assistant_text` | éœ€è¦ yield AdditionalOutputs |
| `schemas.py` | å·²æœ‰ `ConversationState`, `VoiceState` | éœ€æ–°å¢ `ConversationMessage` |
| `reply_on_pause.py` | å»ºç«‹ Stream å’Œ handler | éœ€æ•´åˆè‡ªå®šç¾© UI |
| `main.py` | å•Ÿå‹• `stream.ui.launch()` | å¯èƒ½éœ€èª¿æ•´ |

### ConversationState ç¾æœ‰æ¬„ä½

```python
class ConversationState(BaseModel):
    state: VoiceState              # âœ… å¯ç”¨æ–¼ç‹€æ…‹é¡¯ç¤º
    last_user_text: str | None     # âœ… å¯ç”¨æ–¼å°è©±è¨˜éŒ„
    last_assistant_text: str | None # âœ… å¯ç”¨æ–¼å°è©±è¨˜éŒ„
    turn_count: int                 # âœ… å¯ç”¨æ–¼è¨ˆæ•¸
    started_at: datetime
    last_activity_at: datetime
```

éœ€è¦æ–°å¢ï¼šå®Œæ•´å°è©±æ­·å²åˆ—è¡¨ï¼ˆç›®å‰åªä¿ç•™æœ€å¾Œä¸€è¼ªï¼‰

---

## çµè«–

æ‰€æœ‰æŠ€è¡“å•é¡Œå·²è§£æ±ºï¼Œå¯é€²å…¥ Phase 1 è¨­è¨ˆéšæ®µã€‚ä¸»è¦å¯¦ä½œç­–ç•¥ï¼š

1. **UI å±¤**ï¼šä½¿ç”¨ Gradio Blocks å»ºç«‹è‡ªå®šç¾©ä»‹é¢ï¼ŒåŒ…å« Chatbot å’Œç‹€æ…‹é¡¯ç¤º
2. **è³‡æ–™å±¤**ï¼šæ“´å±• ConversationState æ”¯æ´å®Œæ•´å°è©±æ­·å²
3. **æ•´åˆå±¤**ï¼šé€é AdditionalOutputs å°‡å°è©±è³‡æ–™åŒæ­¥åˆ° UI

---

## åƒè€ƒè³‡æ–™

- [FastRTC Gradio æ•´åˆ](https://fastrtc.org/userguide/gradio/)
- [FastRTC Stream åƒè€ƒ](https://fastrtc.org/reference/stream/)
- [Gradio Chatbot å…ƒä»¶](https://www.gradio.app/docs/gradio/chatbot)
- [Gradio Blocks æŒ‡å—](https://www.gradio.app/guides/blocks-and-event-listeners)
