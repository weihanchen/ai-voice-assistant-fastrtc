# Data Model: Realtime Conversation UI

**Feature**: 005-realtime-conversation-ui
**Date**: 2025-12-31

## æ¦‚è¿°

æœ¬åŠŸèƒ½æ“´å±•ç¾æœ‰ `ConversationState` è³‡æ–™æ¨¡åž‹ï¼Œæ–°å¢žå°è©±æ­·å²è¨˜éŒ„æ”¯æ´ï¼Œä¸¦å®šç¾© UI é¡¯ç¤ºæ‰€éœ€çš„è³‡æ–™çµæ§‹ã€‚

---

## Entity 1: ConversationMessage

å–®ä¸€å°è©±è¨Šæ¯ï¼Œç”¨æ–¼å»ºæ§‹å°è©±æ­·å²ã€‚

### æ¬„ä½å®šç¾©

| æ¬„ä½ | é¡žåž‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜Ž |
|------|------|------|--------|------|
| `role` | `Literal["user", "assistant"]` | âœ… | - | è¨Šæ¯è§’è‰² |
| `content` | `str` | âœ… | - | è¨Šæ¯å…§å®¹ |
| `timestamp` | `datetime` | âœ… | `datetime.now()` | è¨Šæ¯æ™‚é–“æˆ³è¨˜ |

### é©—è­‰è¦å‰‡

- `role` åªèƒ½æ˜¯ `"user"` æˆ– `"assistant"`
- `content` ä¸å¯ç‚ºç©ºå­—ä¸²

### Schema ç¯„ä¾‹

```python
class ConversationMessage(BaseModel):
    role: Literal["user", "assistant"]
    content: str
    timestamp: datetime = Field(default_factory=datetime.now)

    @field_validator("content")
    @classmethod
    def content_not_empty(cls, v: str) -> str:
        if not v.strip():
            raise ValueError("content cannot be empty")
        return v
```

---

## Entity 2: ConversationHistory

å°è©±æ­·å²é›†åˆï¼Œç®¡ç†æ‰€æœ‰å°è©±è¨Šæ¯ã€‚

### æ¬„ä½å®šç¾©

| æ¬„ä½ | é¡žåž‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜Ž |
|------|------|------|--------|------|
| `messages` | `list[ConversationMessage]` | âœ… | `[]` | è¨Šæ¯åˆ—è¡¨ |
| `max_messages` | `int` | âŒ | `40` | æœ€å¤§è¨Šæ¯æ•¸ï¼ˆ20 è¼ª = 40 è¨Šæ¯ï¼‰ |

### è¡Œç‚ºå®šç¾©

| æ–¹æ³• | èªªæ˜Ž |
|------|------|
| `add_user_message(content)` | æ–°å¢žä½¿ç”¨è€…è¨Šæ¯ |
| `add_assistant_message(content)` | æ–°å¢žåŠ©ç†è¨Šæ¯ |
| `to_gradio_format()` | è½‰æ›ç‚º Gradio Chatbot æ ¼å¼ |
| `clear()` | æ¸…ç©ºå°è©±æ­·å² |

### Gradio æ ¼å¼è¼¸å‡º

```python
def to_gradio_format(self) -> list[dict]:
    """è½‰æ›ç‚º Gradio Chatbot æ ¼å¼

    Returns:
        [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]
    """
    return [
        {"role": msg.role, "content": msg.content}
        for msg in self.messages
    ]
```

---

## Entity 3: UIState

UI é¡¯ç¤ºç‹€æ…‹ï¼ŒåŒ…å«ç‹€æ…‹æ–‡å­—å’Œæ¨£å¼è³‡è¨Šã€‚

### æ¬„ä½å®šç¾©

| æ¬„ä½ | é¡žåž‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜Ž |
|------|------|------|--------|------|
| `status_text` | `str` | âœ… | `"ðŸŸ¢ å¾…å‘½"` | ç‹€æ…‹é¡¯ç¤ºæ–‡å­— |
| `voice_state` | `VoiceState` | âœ… | `VoiceState.IDLE` | èªžéŸ³ç‹€æ…‹ |

### ç‹€æ…‹å°æ‡‰è¡¨

| VoiceState | status_text |
|------------|-------------|
| `IDLE` | `"ðŸŸ¢ å¾…å‘½"` |
| `LISTENING` | `"ðŸŽ¤ è†è½ä¸­..."` |
| `PROCESSING` | `"â³ è™•ç†ä¸­..."` |
| `SPEAKING` | `"ðŸ”Š å›žæ‡‰ä¸­..."` |
| `INTERRUPTED` | `"â¸ï¸ å·²ä¸­æ–·"` |

### è¡Œç‚ºå®šç¾©

```python
@classmethod
def from_voice_state(cls, state: VoiceState) -> "UIState":
    """å¾ž VoiceState å»ºç«‹ UIState"""
    status_map = {
        VoiceState.IDLE: "ðŸŸ¢ å¾…å‘½",
        VoiceState.LISTENING: "ðŸŽ¤ è†è¯ä¸­...",
        VoiceState.PROCESSING: "â³ è™•ç†ä¸­...",
        VoiceState.SPEAKING: "ðŸ”Š å›žæ‡‰ä¸­...",
        VoiceState.INTERRUPTED: "â¸ï¸ å·²ä¸­æ–·",
    }
    return cls(
        status_text=status_map[state],
        voice_state=state,
    )
```

---

## æ“´å±•ç¾æœ‰ Entity: ConversationState

ä¿®æ”¹ç¾æœ‰ `ConversationState`ï¼Œæ•´åˆå°è©±æ­·å²ã€‚

### æ–°å¢žæ¬„ä½

| æ¬„ä½ | é¡žåž‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜Ž |
|------|------|------|--------|------|
| `history` | `ConversationHistory` | âŒ | `ConversationHistory()` | å°è©±æ­·å² |

### æ–°å¢žæ–¹æ³•

| æ–¹æ³• | èªªæ˜Ž |
|------|------|
| `add_turn(user_text, assistant_text)` | æ–°å¢žä¸€è¼ªå°è©± |
| `get_ui_state()` | å–å¾— UI é¡¯ç¤ºç‹€æ…‹ |
| `get_gradio_messages()` | å–å¾— Gradio æ ¼å¼è¨Šæ¯ |

---

## è³‡æ–™æµç¨‹

```
ä½¿ç”¨è€…èªžéŸ³è¼¸å…¥
       â”‚
       â–¼
   STT è¾¨è­˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                              â–¼
  LLM è™•ç†                   ConversationHistory.add_user_message()
       â”‚                              â”‚
       â–¼                              â”‚
  å–å¾—å›žæ‡‰                             â”‚
       â”‚                              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â–¼                              â–¼
   TTS æ’­æ”¾            ConversationHistory.add_assistant_message()
       â”‚                              â”‚
       â–¼                              â–¼
AdditionalOutputs(history, status) â”€â”€â–º Gradio UI æ›´æ–°
```

---

## é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ConversationState                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  state: VoiceState                                          â”‚
â”‚  last_user_text: str | None                                 â”‚
â”‚  last_assistant_text: str | None                            â”‚
â”‚  turn_count: int                                            â”‚
â”‚  started_at: datetime                                       â”‚
â”‚  last_activity_at: datetime                                 â”‚
â”‚  history: ConversationHistory  â—„â”€â”€â”€â”€ æ–°å¢ž                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ contains
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ConversationHistory                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  messages: list[ConversationMessage]                        â”‚
â”‚  max_messages: int = 40                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  + add_user_message(content: str)                           â”‚
â”‚  + add_assistant_message(content: str)                      â”‚
â”‚  + to_gradio_format() -> list[dict]                         â”‚
â”‚  + clear()                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ contains (0..*)
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ConversationMessage                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  role: Literal["user", "assistant"]                         â”‚
â”‚  content: str                                               â”‚
â”‚  timestamp: datetime                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UIState                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  status_text: str                                           â”‚
â”‚  voice_state: VoiceState                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  + from_voice_state(state: VoiceState) -> UIState           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
