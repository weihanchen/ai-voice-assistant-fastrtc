# Feature Specification: Stock Price Query

**Feature Branch**: `004-stock-price-query`
**Created**: 2025-12-29
**Status**: Draft
**Input**: 股票報價查詢 - 使用者故事與查詢情境、支援市場 (台股/美股)、yfinance 整合需求、股票名稱對應與成功指標

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查詢單一股票即時報價 (Priority: P1)

使用者透過語音詢問某支股票的價格，例如「台積電現在多少錢」或「Apple 股價多少」。系統辨識股票名稱（中文、英文或股票代碼），查詢即時報價並以語音回覆使用者。

**Why this priority**: 這是股票查詢的核心功能，使用者最常見的需求就是查詢單一股票的即時價格。

**Independent Test**: 可透過語音詢問「台積電現在多少錢」或「Apple 股價」來驗證系統正確辨識並回報股價。

**Acceptance Scenarios**:

1. **Given** 語音助理處於待命狀態, **When** 使用者說「台積電股價多少」, **Then** 系統在 10 秒內回覆台積電（2330.TW）的即時股價
2. **Given** 語音助理處於待命狀態, **When** 使用者說「Apple 現在多少錢」, **Then** 系統在 10 秒內回覆 Apple（AAPL）的即時股價（美元）
3. **Given** 語音助理處於待命狀態, **When** 使用者說「2330 股價」, **Then** 系統正確辨識為台積電並回覆股價

---

### User Story 2 - 處理無法識別的股票 (Priority: P2)

使用者可能說出不存在或系統無法識別的股票名稱。系統應友善地告知無法查詢，並可能提供建議或請使用者換個說法。

**Why this priority**: 錯誤處理是良好使用體驗的一部分，但優先級低於核心查詢功能。

**Independent Test**: 可透過語音詢問一個不存在的股票名稱來驗證系統的錯誤處理。

**Acceptance Scenarios**:

1. **Given** 語音助理處於待命狀態, **When** 使用者說「XYZ123 股價」（不存在的代碼）, **Then** 系統友善回覆「抱歉，找不到這支股票，請確認名稱或代碼是否正確」
2. **Given** 語音助理處於待命狀態, **When** 使用者說「小明公司股價」（不存在的公司）, **Then** 系統回覆無法識別並建議使用股票代碼

---

### Edge Cases

- 當使用者查詢的股票目前休市（非交易時間），系統應回報最近一次收盤價
- 當使用者查詢的股票名稱有多個可能對應，系統應優先回報最常見的一支
- 當 API 服務暫時無法連線，系統應友善告知使用者稍後再試
- 當使用者查詢下市或暫停交易的股票，系統應告知該股票目前無法交易

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 支援以中文股票名稱查詢台股（如「台積電」→ 2330.TW）
- **FR-002**: 系統 MUST 支援以股票代碼查詢台股（如「2330」→ 2330.TW）
- **FR-003**: 系統 MUST 支援以英文公司名稱或股票代碼查詢美股（如「Apple」或「AAPL」→ AAPL）
- **FR-004**: 系統 MUST 回傳股票即時價格（或最近收盤價）
- **FR-005**: 系統 MUST 在查詢失敗時回傳友善的錯誤訊息
- **FR-006**: 系統 MUST 支援台股常見股票的中文別名對照（如「台積電」、「鴻海」、「聯發科」等主要成分股）
- **FR-007**: 系統 MUST 支援美股常見股票的中英對照（如「蘋果」→ AAPL、「特斯拉」→ TSLA）
- **FR-008**: 系統 SHOULD 回傳查詢時間戳記供 LLM 參考
- **FR-009**: 系統 MUST 在 API 逾時時回傳適當的錯誤訊息

### Key Entities

- **StockQuery**: 股票查詢請求，包含使用者輸入的股票名稱或代碼、對應的市場（台股/美股）
- **StockQuote**: 股票報價結果，包含股票代碼、股票名稱、當前價格、貨幣單位、查詢時間
- **StockSymbol**: 股票代碼對照，包含中文名稱、英文名稱、股票代碼、所屬市場

## Clarifications

### Session 2025-12-29

- Q: 股票名稱對照表應涵蓋哪些範圍？ → A: 台股涵蓋台灣 50 成分股；美股涵蓋 S&P 500 前 30 大市值股票
- Q: 即時報價的定義？ → A: 使用 yfinance 提供的最新報價（可能有 15-20 分鐘延遲，需告知使用者）
- Q: 是否需要支援歷史股價或漲跌幅查詢？ → A: 本次規格僅包含即時報價查詢，漲跌幅與歷史查詢為未來擴充功能

## Assumptions

- yfinance 套件可穩定取得台股（.TW 後綴）與美股報價
- 台股代碼格式為「數字.TW」（如 2330.TW），美股代碼為純英文字母
- 使用者主要以繁體中文進行語音查詢
- 報價有 15-20 分鐘延遲為 yfinance 免費版的限制，需在回應中說明
- 股票名稱對照表可於程式碼中硬編碼，不需要動態更新機制

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者從說完股票查詢到聽到價格回覆的時間在 10 秒內
- **SC-002**: 台灣 50 成分股的中文名稱辨識準確率達到 95% 以上
- **SC-003**: 美股前 30 大市值股票的中英文名稱辨識準確率達到 95% 以上
- **SC-004**: 系統在股票服務無法連線時，在 5 秒內回覆友善的錯誤訊息
- **SC-005**: 使用者可連續查詢 10 支不同股票，系統保持穩定回應
